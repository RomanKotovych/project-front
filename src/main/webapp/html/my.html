<html lang="en">
<head>
    <title>RPG</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="/css/my.css">
</head>
<body>
<h1>RPG admin panel</h1>

<div id="paging">
    <label for="countPerPage">Count per page:</label>
    <select id="countPerPage">
        <option value="3">3</option>
        <option value="5">5</option>
        <option value="10">10</option>
        <option value="20">20</option>
    </select>

</div>

<table id="table">
    <thead>
    <tr>
        <th>#</th>
        <th>Name</th>
        <th>Title</th>
        <th>Race</th>
        <th>Profession</th>
        <th>Level</th>
        <th>Birthday</th>
        <th>Banned</th>
        <th>Edit</th>
        <th>Delete</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>
<div id="paginationButtons"></div>

<script>
    $(document).ready(function () {
        let totalElements = 0;
        let currentPage = 0;
        let totalPages = 0;

        $("#countPerPage").on('change', function () {
            currentPage = 0;
            getTotalElements();
        });

        function getTotalElements() {
            $.get('/rest/players/count', function (count) {
                totalElements = count;
                totalPages = Math.ceil(totalElements / $('#countPerPage').val());
                generatePaginationButtons();
                loadData();
            });
        }

        function loadData() {
            const countPerPage = $('#countPerPage').val();

            $.get(`/rest/players?pageNumber=${currentPage}&pageSize=${countPerPage}`, function (data) {
                let tableBody = $('#table tbody');
                tableBody.empty();

                $.each(data, function (index, item) {
                    let newRow = $('<tr>');
                    let date = new Date(item.birthday);

                    let month = (date.getMonth() + 1).toString().padStart(2, '0');
                    let day = date.getDate().toString().padStart(2, '0');
                    let year = date.getFullYear().toString();
                    let birthdate = `${month}/${day}/${year}`;

                    var editImage = $('<img src="/img/edit.png">');
                    var deleteImage = $('<img src="/img/delete.png">');

                    editImage.click(function () {
                        console.log("clicked 1st time");
                        var currentRow = $(this).closest('tr');
                        currentRow.find('td').each(function (index) {
                            var cell = $(this);
                            var text = cell.text();

                            if (index === 1 || index === 2) {
                                cell.empty();
                                var input = $('<input type="text">');
                                input.val(text);
                                cell.append(input);
                            } else if (index === 3) {
                                cell.empty();
                                var races = ["HUMAN", "DWARF", "ELF", "GIANT", "ORC", "TROLL", "HOBBIT"];
                                var dropdown = document.createElement("select");

                                for (var i = 0; i < races.length; i++) {
                                    var option = document.createElement("option");
                                    option.text = races[i];
                                    dropdown.add(option);
                                }

                                cell.append(dropdown);
                            } else if (index === 4) {
                                cell.empty();
                                var professions = ["WARRIOR", "ROGUE", "SORCERER", "CLERIC",
                                    "PALADIN", "NAZGUL", "WARLOCK", "DRUID"];
                                var dropdown = document.createElement("select");

                                for (var i = 0; i < professions.length; i++) {
                                    var option = document.createElement("option");
                                    option.text = professions[i];
                                    dropdown.add(option);
                                }

                                cell.append(dropdown);
                            } else if (index === 7) {
                                cell.empty();
                                var values = ["true", "false"];
                                var dropdown = document.createElement("select");

                                for (var i = 0; i < values.length; i++) {
                                    var option = document.createElement("option");
                                    option.text = values[i];
                                    dropdown.add(option);
                                }

                                cell.append(dropdown);
                            } else if (index === 8) {
                                editImage.attr('src', '/img/save.png');
                            } else if (index === 9) {
                                cell.empty();
                            }

                            editImage.off("click").click(function () {

                                var currentRow = $(this).closest('tr');

                                var name = currentRow.find('td:eq(1) input').val();
                                var title = currentRow.find('td:eq(2) input').val();
                                var race = currentRow.find('td:eq(3) select').val();
                                var profession = currentRow.find('td:eq(4) select').val();
                                var banned = currentRow.find('td:eq(7) select').val();
                                var requestData = {
                                    "name": name,
                                    "title": title,
                                    "race": race,
                                    "profession": profession,
                                    "banned": banned,
                                };

                                $.ajax({
                                    type: "POST",
                                    url: "/rest/players/" + item.id,
                                    contentType: "application/json",
                                    data: JSON.stringify(requestData),
                                    success: function (response) {
                                        getTotalElements();
                                    },
                                    error: function (error) {
                                        alert(error.message);
                                    }
                                });

                            })

                        })
                    })

                    deleteImage.click(function () {
                        var playerId = item.id;
                        $.ajax({
                            type: 'DELETE',
                            url: '/rest/players/' + playerId,
                            success: function (response) {
                                getTotalElements()
                            },
                            error: function (error) {
                                alert('Error');
                            }
                        });
                    });


                    newRow.append('<td>' + item.id + '</td>');
                    newRow.append('<td>' + item.name + '</td>');
                    newRow.append('<td>' + item.title + '</td>');
                    newRow.append('<td>' + item.race + '</td>');
                    newRow.append('<td>' + item.profession + '</td>');
                    newRow.append('<td>' + item.level + '</td>');
                    newRow.append('<td>' + birthdate + '</td>');
                    newRow.append('<td>' + item.banned + '</td>');
                    newRow.append($('<td>').append(editImage));
                    newRow.append($('<td>').append(deleteImage));

                    tableBody.append(newRow);
                });

                generatePaginationButtons();
            });
        }

        function generatePaginationButtons() {
            let paginationDiv = $('#paginationButtons');
            paginationDiv.empty();

            for (let i = 1; i <= totalPages; i++) {
                let button = $('<button>').text(i);
                if (i - 1 === currentPage) {
                    button.addClass('active');
                }
                button.on('click', function () {
                    currentPage = i - 1;
                    loadData();
                });

                paginationDiv.append(button);
            }
        }

        getTotalElements();
    });
</script>
</body>
</html>
